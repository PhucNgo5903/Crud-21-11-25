<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý User (CRUD)</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        
        /* Toolbar styles */
        .toolbar { display: flex; justify-content: space-between; margin-bottom: 20px; }
        input[type="text"] { padding: 8px; width: 300px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; }
        .btn-add { background-color: #28a745; }
        .btn-edit { background-color: #ffc107; color: black; }
        .btn-delete { background-color: #dc3545; }
        .btn-save { background-color: #007bff; }
        .btn-cancel { background-color: #6c757d; }

        /* Table styles */
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #007bff; color: white; }
        tr:hover { background-color: #f1f1f1; }

        /* Pagination */
        .pagination { text-align: center; margin-top: 20px; }
        .pagination button { background-color: #007bff; margin: 0 5px; }
        .pagination button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Modal Form */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 5px; width: 400px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input { width: 100%; padding: 8px; box-sizing: border-box; }
        .modal-actions { text-align: right; }
    </style>
</head>
<body>

<div class="container">
    <h1>Quản lý người dùng</h1>
    
    <div class="toolbar">
        <input type="text" id="searchInput" placeholder="Tìm kiếm theo tên..." oninput="handleSearch()">
        <button class="btn-add" onclick="openModal()">+ Thêm người dùng</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Tên (Name)</th>
                <th>Email</th>
                <th>Điện thoại (Phone)</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody id="userTableBody">
            </tbody>
    </table>

    <div class="pagination">
        <button id="btnPrev" onclick="changePage(-1)">Trước</button>
        <span id="pageInfo">Trang 1</span>
        <button id="btnNext" onclick="changePage(1)">Sau</button>
    </div>
</div>

<div id="userModal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle">Thêm người dùng</h2>
        <input type="hidden" id="userId">
        <div class="form-group">
            <label>Tên:</label>
            <input type="text" id="userName">
        </div>
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="userEmail">
        </div>
        <div class="form-group">
            <label>Điện thoại:</label>
            <input type="text" id="userPhone">
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal()">Hủy</button>
            <button class="btn-save" onclick="saveUser()">Lưu</button>
        </div>
    </div>
</div>

<script>
    // Cấu hình chung
    const API_URL = 'https://jsonplaceholder.typicode.com/users';
    let users = []; // Biến lưu trữ danh sách user (Local state)
    let filteredUsers = []; // Danh sách user sau khi search
    
    // Cấu hình Pagination
    let currentPage = 1;
    const itemsPerPage = 5;

    // 1. READ: Lấy dữ liệu từ API (sử dụng async/await như trang 53)
    async function fetchUsers() {
        try {
            const response = await axios.get(API_URL);
            users = response.data;
            filteredUsers = users; // Ban đầu chưa search thì giống nhau
            renderTable();
        } catch (error) {
            console.error("Lỗi khi tải dữ liệu:", error);
            alert("Không thể tải danh sách người dùng.");
        }
    }

    // Hàm render dữ liệu ra bảng (bao gồm cả logic phân trang)
    function renderTable() {
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';

        // Tính toán phân trang
        const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
        // Đảm bảo currentPage hợp lệ
        if (currentPage > totalPages) currentPage = totalPages > 0 ? totalPages : 1;
        if (currentPage < 1) currentPage = 1;

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedUsers = filteredUsers.slice(start, end);

        // Render từng dòng
        paginatedUsers.forEach(user => {
            const row = `<tr>
                <td>${user.id}</td>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${user.phone}</td>
                <td>
                    <button class="btn-edit" onclick="prepareEdit(${user.id})">Sửa</button>
                    <button class="btn-delete" onclick="deleteUser(${user.id})">Xóa</button>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });

        // Cập nhật thông tin phân trang
        document.getElementById('pageInfo').innerText = `Trang ${currentPage} / ${totalPages || 1}`;
        document.getElementById('btnPrev').disabled = currentPage === 1;
        document.getElementById('btnNext').disabled = currentPage === totalPages || totalPages === 0;
    }

    // 2. CREATE & UPDATE: Xử lý lưu người dùng
    async function saveUser() {
        const id = document.getElementById('userId').value;
        const name = document.getElementById('userName').value;
        const email = document.getElementById('userEmail').value;
        const phone = document.getElementById('userPhone').value;

        if (!name || !email) {
            alert("Vui lòng nhập tên và email.");
            return;
        }

        const userData = { name, email, phone };

        try {
            if (id) {
                // --- UPDATE (PUT) ---
                // Gọi API giả lập
                await axios.put(`${API_URL}/${id}`, userData);
                
                // Cập nhật UI thủ công (Manual update UI)
                const index = users.findIndex(u => u.id == id);
                if (index !== -1) {
                    users[index] = { ...users[index], ...userData };
                }
                alert("Cập nhật thành công (Fake)!");
            } else {
                // --- CREATE (POST) ---
                // Gọi API giả lập
                const response = await axios.post(API_URL, userData);
                
                // Cập nhật UI thủ công: Tạo ID mới giả vì API luôn trả về 11
                const newUser = { ...userData, id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1 };
                users.push(newUser);
                alert("Thêm mới thành công (Fake)!");
            }

            // Reset lại search và render
            document.getElementById('searchInput').value = '';
            filteredUsers = users;
            currentPage = 1; // Quay về trang đầu để thấy thay đổi
            renderTable();
            closeModal();

        } catch (error) {
            console.error("Lỗi khi lưu:", error);
            alert("Có lỗi xảy ra.");
        }
    }

    // 3. DELETE: Xóa người dùng
    async function deleteUser(id) {
        if (confirm("Bạn có chắc chắn muốn xóa người dùng này?")) {
            try {
                await axios.delete(`${API_URL}/${id}`);
                
                // Cập nhật UI thủ công (Manual UI Update)
                users = users.filter(user => user.id !== id);
                
                // Cập nhật lại danh sách đã filter (nếu đang search)
                handleSearch(); 
                alert("Đã xóa thành công (Fake)!");
            } catch (error) {
                console.error("Lỗi khi xóa:", error);
                alert("Không thể xóa người dùng.");
            }
        }
    }

    // 4. SEARCH: Tìm kiếm theo tên
    function handleSearch() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        if (query) {
            filteredUsers = users.filter(user => user.name.toLowerCase().includes(query));
        } else {
            filteredUsers = users;
        }
        currentPage = 1; // Reset về trang 1 khi tìm kiếm
        renderTable();
    }

    // 5. PAGINATION: Chuyển trang
    function changePage(step) {
        currentPage += step;
        renderTable();
    }

    // --- Các hàm hỗ trợ UI (Modal) ---
    function openModal() {
        document.getElementById('userModal').style.display = 'flex';
        document.getElementById('modalTitle').innerText = "Thêm người dùng";
        document.getElementById('userId').value = '';
        document.getElementById('userName').value = '';
        document.getElementById('userEmail').value = '';
        document.getElementById('userPhone').value = '';
    }

    function prepareEdit(id) {
        const user = users.find(u => u.id == id);
        if (user) {
            document.getElementById('userModal').style.display = 'flex';
            document.getElementById('modalTitle').innerText = "Sửa người dùng";
            document.getElementById('userId').value = user.id;
            document.getElementById('userName').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userPhone').value = user.phone;
        }
    }

    function closeModal() {
        document.getElementById('userModal').style.display = 'none';
    }

    // Khởi chạy ứng dụng
    fetchUsers();

</script>

</body>
</html>